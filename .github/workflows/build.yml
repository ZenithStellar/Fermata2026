name: Build Fermata v2026

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Create JKS Keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.jks \
            -alias fermakey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -storepass "password123" \
            -keypass "password123" \
            -dname "CN=Fermamode, OU=ID, O=Fermamode, L=World, S=World, C=US"

      - name: Force Exact Package Name (Hard Reset)
        # This deletes any line containing applicationIdSuffix to stop .auto from being added
        run: |
          sed -i '/applicationIdSuffix/d' fermata/build.gradle
          # Double check the package name is set correctly
          echo "Overriding Application ID in gradle.properties..."
          echo "APP_ID=fermamode.v2026" >> gradle.properties

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Universal Release APK
        # We pass the ID again here as a backup
        run: ./gradlew fermata:assembleAutoRelease -PAPP_ID=fermamode.v2026

      - name: Align and Sign APK
        run: |
          # 1. Find the APK (it should now be named fermamode.v2026 internally)
          UNSIGNED_APK=$(find fermata/build/outputs/apk/auto/release -name "*.apk" | head -n 1)
          
          # 2. Zipalign
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v 4 "$UNSIGNED_APK" fermamode_aligned.apk
          
          # 3. Sign
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks release.jks \
            --ks-pass pass:password123 \
            --ks-key-alias fermakey \
            --key-pass pass:password123 \
            --out fermamode.v2026.apk \
            fermamode_aligned.apk
            
          # 4. Final verification of the Package Name inside the APK
          $ANDROID_HOME/build-tools/34.0.0/aapt dump badging fermamode.v2026.apk | grep package

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: fermamode.v2026-signed
          path: fermamode.v2026.apk
