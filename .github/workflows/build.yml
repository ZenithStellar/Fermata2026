name: Build Fermata v2026

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Create JKS Keystore
        # We use -storetype JKS to avoid the "Tag number over 30" error
        run: |
          keytool -genkeypair -v \
            -keystore release.jks \
            -alias fermakey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -storepass "password123" \
            -keypass "password123" \
            -dname "CN=Fermamode, OU=ID, O=Fermamode, L=World, S=World, C=US"

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Universal Release APK
        # Passing -PAPP_ID overrides the application package name
        run: ./gradlew fermata:assembleAutoRelease -PAPP_ID=fermamode.v2026

      - name: Align and Sign APK
        run: |
          # 1. Find the unsigned APK generated by Gradle
          UNSIGNED_APK=$(find fermata/build/outputs/apk/auto/release -name "*.apk" | head -n 1)
          echo "Found unsigned APK: $UNSIGNED_APK"
          
          # 2. Zipalign the APK
          $ANDROID_HOME/build-tools/34.0.0/zipalign -v 4 "$UNSIGNED_APK" fermamode_aligned.apk
          
          # 3. Sign the APK using the JKS keystore
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks release.jks \
            --ks-pass pass:password123 \
            --ks-key-alias fermakey \
            --key-pass pass:password123 \
            --out fermamode.v2026.apk \
            fermamode_aligned.apk
            
          # 4. Verify the signature
          $ANDROID_HOME/build-tools/34.0.0/apksigner verify fermamode.v2026.apk

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: fermamode.v2026-signed
          path: fermamode.v2026.apk
