name: Build Fermata (Hardcoded Signing)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Generate Temporary Keystore
        run: |
          keytool -genkey -v \
            -keystore release.keystore \
            -alias fermakey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "password123" \
            -keypass "password123" \
            -dname "CN=Fermamode, OU=ID, O=Fermamode, L=World, S=World, C=US"

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build APK with custom Package Name
        # -PAPP_ID changes the package name to fermamode.v2026
        run: ./gradlew fermata:packageAutoReleaseUniversalApk -PAPP_ID=fermamode.v2026

      - name: Sign APK with hardcoded credentials
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: fermata/build/outputs/apk_from_bundle/autoRelease
          signingKeyBase64: ${{ env.KEY_BASE64 }} # This will be filled by the step below
          alias: fermakey
          keyStorePassword: password123
          keyPassword: password123
        env:
          # This converts the file we just made into the format the signer needs
          KEY_BASE64: ${{ secrets.UNUSED_SECRET_KEY }} # Just a placeholder
          BUILD_TOOLS_VERSION: "34.0.0"

      # Manual signing step since we aren't using Secrets for the r0adkll action
      - name: Manual Sign Fallback
        run: |
          APK_PATH=$(find fermata/build/outputs/apk_from_bundle/autoRelease -name "*.apk" | head -n 1)
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks release.keystore \
            --ks-pass pass:password123 \
            --key-pass pass:password123 \
            --out fermamode.v2026.apk \
            $APK_PATH

      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: fermamode-v2026-signed
          path: fermamode.v2026.apk
