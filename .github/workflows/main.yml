name: Build and Sign Fermata Auto

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout:v4
        with:
          submodules: recursive # Required for Fermata's dependencies

      - name: Set up JDK 17
        uses: actions/setup-java:v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Modify Package Name and Version
        run: |
          # Change Package Name in fermata/build.gradle
          # We replace the logic that builds the ID with your hardcoded name
          sed -i 's/applicationId .*/applicationId "fermamode.2026"/' fermata/build.gradle
          
          # Change Version Name and Code
          sed -i 's/versionName .*/versionName "2.0.1"/' fermata/build.gradle
          sed -i 's/versionCode .*/versionCode 201/' fermata/build.gradle
          
          # Optional: Update the ID in the 'control' module as well to ensure compatibility
          if [ -f "control/build.gradle" ]; then
            sed -i 's/applicationId .*/applicationId "fermamode.2026.control"/' control/build.gradle
          fi

      - name: Build Android Auto Bundle (AAB)
        run: ./gradlew :fermata:bundleAutoRelease
        env:
          # Discarding automotive parts by targeting only the 'Auto' flavor
          # and skipping GMS/Google Services if not needed
          NO_GS: true 

      - name: Sign AAB
        id: sign_app
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: fermata/build/outputs/bundle/autoRelease
          signingKeyBase64: ${{ secrets.KEYSTORE_BASE64 }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fermata-auto-2.0.1
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}
